    {% load markup %}
    {% load i18n %}
    {% load mptt_tags %}
    {% load mptt_comments_tags %}
    {% load comparison %}

    {% for comment, tree in comments|tree_info %}
    
    {% if not tree.new_level %}</div>{% endif %}
    
    <div class="comment comment_level_{{ comment.level }}
            {% if_greater comment.level collapse_levels_above %} comment_collapsed{% endif_greater %}
            " id="comment_{{ comment.pk }}">
    
    <h3><a class="comment_expand" href="{% url comment-detail comment.pk %}">{% trans "Commented by" %} {{ comment.name }} -
        {{ comment.submit_date|date:"l" }} {% trans "on" %}
        {{ comment.submit_date|date:"j F" }} {% trans "at" %}
        {{ comment.submit_date|date:"H:i" }}</a>:
    </h3>
    
    <div class="comment_content {% if_less comment.level collapse_levels_below %} comment_collapsed_below{% endif_less %}">

    {{ comment.comment|markdown }}
    
    <p>
        {% if comment|children_count %}{% ifequal comment.level cutoff_level %}
            <a class="comment_replies" href="{% url comments-subtree comment.pk %}">
        {% endifequal %}{% endif %}
            {{ comment|children_count }} {% trans "replies" %}
        {% if comment|children_count %}{% ifequal comment.level cutoff_level %}
            </a>
        {% endifequal %}{% endif %}            
            | 
        <a class="comment_reply" href="{% url comment-reply comment.pk %}">
            {% trans "Reply to this comment" %}
        </a>
    </p>
    
    </div>
   
   {% for level in tree.closed_levels %}
   
        {% if forloop.parentloop.last %}
            {# not the topmost tree, skip closing some levels #}         
            {% if_greater level bottom_level %}</div>{% endif_greater %}
        {% else %}
            </div>
        {% endif %}

   {% endfor %}
   
   {% endfor %}   
